{% extends 'base.html' %}

{% block title %}{{ movie.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#050505] text-white font-sans selection:bg-indigo-500/30">
    <div class="max-w-6xl mx-auto pt-10 pb-20 px-6" 
         x-data="moviePage({ 
            movieId: {{ movie.id }}, 
            initialRating: {{ user_rating|default:'null' }} 
         })">
        
        <div class="flex flex-col lg:flex-row gap-16">
            <div class="w-full lg:w-72 flex-shrink-0">
                <div class="sticky top-24">
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-b from-indigo-600 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                        <img src="{{ movie.poster.url }}" class="relative w-full rounded-2xl shadow-2xl border border-white/10">
                    </div>
                    
                    <div class="mt-6 space-y-3">
                        <button class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3.5 rounded-xl font-black text-[11px] uppercase tracking-widest transition-all shadow-lg shadow-indigo-900/20">
                            Смотреть фильм
                        </button>
                        <button class="w-full bg-white/5 hover:bg-white/10 text-gray-400 py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest border border-white/5 transition-all">
                            В коллекцию
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-start mb-12 gap-8">
                    <div class="max-w-2xl">
                        <h1 class="text-5xl font-extrabold tracking-tighter leading-none bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                            {{ movie.name }}
                        </h1>
                        <p class="text-xl text-indigo-400/80 mt-3 font-medium tracking-wide">{{ movie.name_original|default:"" }}</p>
                    </div>
                    
                    <div class="flex items-center gap-6 bg-white/[0.03] backdrop-blur-xl p-4 rounded-2xl border border-white/10 shadow-2xl">
                        <div class="text-center">
                            <span class="block text-4xl font-black text-indigo-500 leading-none">{{ movie.average_rating|default:"0.0" }}</span>
                            <span class="text-[9px] text-gray-500 font-black uppercase tracking-[0.2em] mt-2 block">WatchNext</span>
                        </div>
                        <div class="h-10 w-px bg-white/10"></div>
                        <div class="relative">
                            <button @click="showRate = !showRate" 
                                    class="group flex flex-col items-center justify-center w-14 h-14 bg-indigo-500/10 hover:bg-indigo-500/20 rounded-xl border border-indigo-500/30 hover:border-indigo-500 transition-all">
                                <span class="text-xl text-indigo-500 group-hover:scale-110 transition-transform" x-text="rating || '★'"></span>
                                <span class="text-[7px] font-black text-indigo-400 uppercase tracking-tighter mt-0.5" x-text="rating ? 'Твой балл' : 'Оценить'"></span>
                            </button>
                            
                            <div x-show="showRate" @click.away="showRate = false" 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 translate-y-2"
                                 class="absolute right-0 mt-4 p-1.5 bg-[#0f0f0f] border border-white/10 rounded-xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] z-50 flex gap-1" x-cloak>
                                <template x-for="n in 10">
                                    <button @click="setRating(n); showRate = false" 
                                            :class="rating == n ? 'bg-indigo-600 text-white' : 'text-gray-500 hover:bg-white/5 hover:text-white'"
                                            class="w-8 h-8 flex items-center justify-center rounded-lg text-[11px] font-black transition-all">
                                        <span x-text="n"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-12">
                    <section>
                        <h2 class="text-[11px] font-black text-indigo-500/50 uppercase tracking-[0.3em] mb-6">Детали публикации</h2>
                        <div class="grid grid-cols-[180px_1fr] gap-y-5 text-[15px]">
                            <div class="text-gray-500 font-semibold">Релиз</div>
                            <div class="text-gray-200">{{ movie.release_year }}</div>
                            
                            <div class="text-gray-500 font-semibold">Направление</div>
                            <div class="flex gap-2">
                                <span class="px-2 py-0.5 bg-indigo-500/10 text-indigo-400 text-[11px] font-black rounded uppercase tracking-wider border border-indigo-500/20">Драма</span>
                                <span class="px-2 py-0.5 bg-indigo-500/10 text-indigo-400 text-[11px] font-black rounded uppercase tracking-wider border border-indigo-500/20">Криминал</span>
                            </div>
                            
                            <div class="text-gray-500 font-semibold">Режиссер</div>
                            <div class="flex flex-wrap gap-2">
                                {% for person in movie.directors.all %}
                                    <div class="relative inline-block group" x-data="{ pop: false }">
                                        <span @mouseenter="pop = true" @mouseleave="pop = false" 
                                              class="text-white border-b border-indigo-500/30 hover:border-indigo-500 cursor-help transition-all pb-0.5">
                                            {{ person.name }}{% if not forloop.last %}, {% endif %}
                                        </span>
                                        <div x-show="pop" class="absolute bottom-full left-0 mb-4 w-72 p-4 bg-black/80 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-2xl z-50" x-cloak x-transition>
                                            <div class="flex gap-4">
                                                <img src="{{ person.photo.url }}" class="w-20 h-24 object-cover rounded-xl shadow-lg border border-white/5">
                                                <div class="min-w-0">
                                                    <p class="text-xs font-black text-white uppercase mb-1">{{ person.name }}</p>
                                                    <p class="text-[10px] text-gray-400 leading-relaxed italic">{{ person.bio|truncatechars:90 }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="text-gray-500 font-semibold">В главных ролях</div>
                            <div class="flex flex-wrap gap-x-3">
                                {% for person in movie.actors.all %}
                                    <div class="relative inline-block" x-data="{ pop: false }">
                                        <span @mouseenter="pop = true" @mouseleave="pop = false" 
                                              class="text-gray-400 hover:text-white cursor-help transition-all">
                                            {{ person.name }}{% if not forloop.last %}, {% endif %}
                                        </span>
                                        <div x-show="pop" class="absolute bottom-full left-0 mb-4 w-72 p-4 bg-black/80 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-2xl z-50" x-cloak x-transition>
                                            <div class="flex gap-4">
                                                <img src="{{ person.photo.url }}" class="w-20 h-24 object-cover rounded-xl shadow-lg border border-white/5">
                                                <div>
                                                    <p class="text-xs font-black text-white uppercase mb-1">{{ person.name }}</p>
                                                    <p class="text-[10px] text-gray-400 leading-relaxed italic">{{ person.bio|truncatechars:90 }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-[11px] font-black text-indigo-500/50 uppercase tracking-[0.3em] mb-4">История</h2>
                        <p class="text-gray-400 leading-relaxed text-[16px] max-w-3xl font-light">
                            {{ movie.description }}
                        </p>
                    </section>
                </div>
            </div>
        </div>

        <div class="mt-32 border-t border-white/5 pt-20">
            <div class="flex items-end gap-4 mb-16">
                <h2 class="text-4xl font-black text-white uppercase tracking-tighter leading-none">Рецензии</h2>
                <span class="text-indigo-500 font-black text-xl leading-none">{{ movie.reviews.count }}</span>
            </div>

            <div class="space-y-16">
                {% for review in movie.reviews.all %}
                <div class="flex gap-8 items-start group">
                    <div class="relative flex-shrink-0">
                        <div class="absolute -inset-1 bg-indigo-500 rounded-2xl blur opacity-20 group-hover:opacity-40 transition"></div>
                        <div class="relative w-14 h-14 rounded-2xl bg-[#0f0f0f] border border-white/10 flex items-center justify-center font-black text-indigo-500 text-sm">
                            {{ review.user.username|slice:":1"|upper }}
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-3">
                            <span class="text-sm font-black text-white uppercase tracking-widest">{{ review.user.username }}</span>
                            <span class="h-1 w-1 bg-indigo-500 rounded-full"></span>
                            <span class="text-[10px] text-gray-600 font-bold uppercase">{{ review.created_at|date:"d M Y" }}</span>
                        </div>
                        <div class="relative bg-white/[0.02] p-8 rounded-3xl rounded-tl-none border border-white/5 group-hover:border-indigo-500/20 transition-all">
                            <p class="text-gray-300 text-[15px] leading-relaxed font-light italic">
                                «{{ review.text }}»
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function moviePage(config) {
    return {
        movieId: config.movieId,
        rating: config.initialRating,
        showRate: false,
        async setRating(val) {
            const token = localStorage.getItem('access_token');
            if (!token) return window.location.href = '/login/';
            const res = await fetch('/api/v1/ratings/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ movie: this.movieId, value: val })
            });
            if (res.ok) this.rating = val;
        }
    }
}
</script>
{% endblock %}